[Unit]
Description=Woodpecker Agent Container
After=network-online.target infrastructure.network woodpecker-server.container woodpecker-agent.volume
Requires=podman.socket woodpecker-server.container
Wants=network-online.target infrastructure.network woodpecker-server.container woodpecker-agent.volume
StartLimitBurst=3

[Container]
ContainerName=woodpecker-agent
HostName=woodpecker-agent
Image=docker.io/woodpeckerci/woodpecker-agent:v3

Exec=agent

Network=infrastructure.network

EnvironmentFile=/var/home/badger/containers/config/default.env

Secret=woodpecker-agent-secret,type=env,target=WOODPECKER_AGENT_SECRET

Environment=WOODPECKER_SERVER=woodpecker-server:9000
Environment=WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}
Environment=PODMAN_NETWORK_DNS=true
Environment=WOODPECKER_BACKEND_DOCKER_NETWORK=systemd-infrastructure
# Environment=SYSTEMD_RESOLV_CONFIG=/run/systemd/resolve/resolv.conf

# Environment=WOODPECKER_BACKEND_DOCKER_NETWORK=ops_default

AutoUpdate=registry

Timezone=${TZ}

Volume=woodpecker-agent.volume:/etc/woodpecker:Z
# Had to run systemctl --user enable --now podman.socket
Volume=/run/user/1001/podman/podman.sock:/var/run/docker.sock:z
# Had to create custom daemon.json to mark badger-registry:5000 as an insecure registry
Volume=/var/home/badger/containers/data/woodpecker/docker/daemon.json:/etc/docker/daemon.json:Z

SecurityLabelDisable=true
UserNS=keep-id

# Notify=true

[Service]
Restart=on-failure

[Install]
WantedBy=default.target